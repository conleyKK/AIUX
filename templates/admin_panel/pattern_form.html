{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}
    {% if pattern %}ç¼–è¾‘è®¾è®¡æ¨¡å¼{% else %}åˆ›å»ºè®¾è®¡æ¨¡å¼{% endif %}
<!-- Lottieç¼–è¾‘å™¨ä¼˜åŒ– -->
<style>
.ql-editor .ql-lottie {
    display: inline-flex !important;
    align-items: center !important;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)) !important;
    border: 1px solid rgba(34, 197, 94, 0.3) !important;
    border-radius: 20px !important;
    padding: 4px 12px !important;
    margin: 0 4px !important;
    font-size: 12px !important;
    color: rgba(34, 197, 94, 0.9) !important;
    cursor: pointer !important;
    max-width: 200px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    font-weight: 500 !important;
    vertical-align: middle !important;
}
</style>
{% endblock %}

{% block extra_css %}
<!-- Quill.js CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<!-- Lottie Player CSS -->
<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .editor-container {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: #111827;
    }
    
    #quill-editor {
        min-height: 300px;
    }
    
    .ql-toolbar {
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .ql-container {
        border-bottom-left-radius: 6px;
        border-bottom-right-radius: 6px;
        font-size: 16px;
        line-height: 1.6;
        background: #111827;
        color: #fff;
    }
    
    /* Lottieç›¸å…³æ ·å¼ - ç°ä»£åŒ–è®¾è®¡ */
    .lottie-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        margin: 1rem 0;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .lottie-upload-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.05), transparent);
        transition: left 0.5s;
    }
    
    .lottie-upload-area:hover {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    }
    
    .lottie-upload-area:hover::before {
        left: 100%;
    }
    
    .lottie-upload-area.dragover {
        border-color: #2563eb;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        transform: scale(1.02);
        box-shadow: 0 12px 30px rgba(59, 130, 246, 0.2);
    }
    
    .lottie-upload-area .upload-content {
        position: relative;
        z-index: 1;
    }
    
    .lottie-upload-area .upload-content i {
        color: #64748b;
        transition: all 0.3s ease;
    }
    
    .lottie-upload-area:hover .upload-content i {
        color: #3b82f6;
        transform: scale(1.1);
    }
    
    .lottie-preview {
        display: inline-block;
        margin: 12px;
        padding: 16px;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .lottie-preview:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        border-color: #cbd5e1;
    }
    
    .lottie-preview lottie-player {
        width: 200px;
        height: 150px;
        border-radius: 12px;
        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.06));
    }
    
    .lottie-preview .lottie-info {
        margin-top: 12px;
        padding: 8px;
        background: rgba(248, 250, 252, 0.8);
        border-radius: 8px;
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
    }
    
    .lottie-preview .lottie-info strong {
        color: #334155;
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
    }
    
    .lottie-controls {
        margin-top: 12px;
        display: flex;
        justify-content: center;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .lottie-btn {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        background: #ffffff;
        cursor: pointer;
        font-size: 10px;
        font-weight: 500;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }
    
    .lottie-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.3s;
    }
    
    .lottie-btn:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .lottie-btn:hover::before {
        left: 100%;
    }
    
    .lottie-btn.primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-color: #3b82f6;
    }
    
    .lottie-btn.primary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .lottie-btn.danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-color: #ef4444;
    }
    
    .lottie-btn.danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    /* ç¼–è¾‘å™¨ä¸­çš„Lottieæ¨¡å— - ç®€æ´ç´§å‡‘æ ·å¼ */
    .ql-editor .lottie-embed {
        position: relative;
        display: inline-block;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 8px;
        padding: 8px 12px;
        margin: 4px 8px;
        font-size: 12px;
        color: rgba(34, 197, 94, 0.9);
        cursor: pointer;
        transition: all 0.2s ease;
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .ql-editor .lottie-embed:hover {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15));
        border-color: rgba(34, 197, 94, 0.5);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
    }

    /* éšè—ç¼–è¾‘å™¨ä¸­çš„lottie-player */
    .ql-editor .lottie-embed lottie-player {
        display: none !important;
    }

    /* éšè—ç¼–è¾‘å™¨ä¸­çš„è¯¦ç»†ä¿¡æ¯å’Œæ§åˆ¶æŒ‰é’® */
    .ql-editor .lottie-embed .lottie-info,
    .ql-editor .lottie-embed .lottie-controls {
        display: none !important;
    }

    /* ç¼–è¾‘å™¨ä¸­åªæ˜¾ç¤ºç®€æ´çš„æ–‡æœ¬æ ‡è¯† */
    .ql-editor .lottie-embed::before {
        content: "ğŸ¬ ";
        font-size: 14px;
        margin-right: 4px;
    }

    /* æ’­æ”¾çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .ql-editor .lottie-embed::after {
        content: '';
        position: absolute;
        top: 4px;
        right: 4px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: rgba(34, 197, 94, 0.6);
        box-shadow: 0 0 4px rgba(34, 197, 94, 0.4);
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2563eb;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
        margin-right: 1rem;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .file-upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #f9fafb;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .file-upload-area:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    
    .file-upload-area.dragover {
        border-color: #3b82f6;
        background: #dbeafe;
    }
    
    .current-image {
        margin-top: 1rem;
        text-align: center;
    }
    
    .current-image img {
        max-width: 200px;
        max-height: 150px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .form-actions {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .success-message {
        background: #d1fae5;
        color: #065f46;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid #a7f3d0;
    }
    
    .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid #fca5a5;
    }
</style>
<!-- Lottieç¼–è¾‘å™¨ä¼˜åŒ– -->
<style>
.ql-editor .ql-lottie {
    display: inline-flex !important;
    align-items: center !important;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)) !important;
    border: 1px solid rgba(34, 197, 94, 0.3) !important;
    border-radius: 20px !important;
    padding: 4px 12px !important;
    margin: 0 4px !important;
    font-size: 12px !important;
    color: rgba(34, 197, 94, 0.9) !important;
    cursor: pointer !important;
    max-width: 200px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    font-weight: 500 !important;
    vertical-align: middle !important;
}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">
        {% if pattern %}ç¼–è¾‘è®¾è®¡æ¨¡å¼{% else %}åˆ›å»ºè®¾è®¡æ¨¡å¼{% endif %}
    </h1>
    
    <form method="post" enctype="multipart/form-data" id="pattern-form">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="title">æ¨¡å¼æ ‡é¢˜ *</label>
            <input type="text" id="title" name="title" class="form-control" 
                   value="{{ pattern.title|default:'' }}" required
                   placeholder="è¯·è¾“å…¥è®¾è®¡æ¨¡å¼æ ‡é¢˜">
        </div>
        
        <div class="form-group">
            <label for="description">æ¨¡å¼æè¿° *</label>
            <textarea id="description" name="description" class="form-control" 
                      rows="3" required placeholder="è¯·ç®€è¦æè¿°è¿™ä¸ªè®¾è®¡æ¨¡å¼">{{ pattern.description|default:'' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="category">æ‰€å±åˆ†ç±» *</label>
            <select id="category" name="category" class="form-control" required>
                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}" 
                            {% if pattern.category_id == cat.id %}selected{% endif %}>
                        {{ cat.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="tags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
            <input type="text" id="tags" name="tags" class="form-control" 
                   value="{{ pattern.tags|default:'' }}" 
                   placeholder="ä¾‹å¦‚ï¼šäº¤äº’è®¾è®¡, ç”¨æˆ·ä½“éªŒ, ç§»åŠ¨ç«¯">
        </div>
        
        <div class="form-group">
            <label for="cover_image">å°é¢å›¾ç‰‡</label>
            <div class="file-upload-area" id="cover-upload-area">
                <input type="file" id="cover_image" name="cover_image" 
                       accept="image/*" style="display: none;">
                <div class="upload-content">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å°é¢å›¾ç‰‡</p>
                    <p class="text-sm text-gray-500">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 800x600</p>
                </div>
                {% if pattern.cover_image %}
                    <div class="current-image">
                        <p class="text-sm text-gray-600 mb-2">å½“å‰å›¾ç‰‡ï¼š</p>
                        <img src="{{ pattern.cover_image.url }}" alt="å½“å‰å°é¢">
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-group">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <label>è¯¦ç»†å†…å®¹ *</label>
                <button type="button" onclick="clearEditor()" style="font-size: 12px; color: #dc2626; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: all 0.2s ease;">
                    ğŸ—‘ï¸ æ¸…ç©ºç¼–è¾‘å™¨
                </button>
            </div>
            <div class="editor-container">
                <div id="quill-editor"></div>
            </div>
            <input type="hidden" id="content-input" name="content" 
                   value="{{ pattern.content|default:'' }}">
        </div>
        
        <!-- Lottieæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="form-group">
            <label>LottieåŠ¨ç”»æ–‡ä»¶</label>
            <div class="lottie-upload-area" id="lottie-upload-area">
                <input type="file" id="lottie-file" accept=".json,.lottie" style="display: none;" multiple>
                <div class="upload-content">
                    <i class="fas fa-play-circle text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ LottieåŠ¨ç”»æ–‡ä»¶</p>
                    <p class="text-sm text-gray-500">æ”¯æŒ .json å’Œ .lottie æ ¼å¼</p>
                </div>
            </div>
            <div id="lottie-previews" class="mt-4"></div>
        </div>
        
        <div class="form-group">
            <label class="flex items-center">
                <input type="checkbox" name="is_featured" class="mr-2"
                       {% if pattern.is_featured %}checked{% endif %}>
                <span class="font-medium">æ¨èæ¨¡å¼</span>
                <span class="text-sm text-gray-500 ml-2">ï¼ˆæ¨èçš„æ¨¡å¼ä¼šåœ¨é¦–é¡µæ˜¾ç¤ºï¼‰</span>
            </label>
        </div>
        
        <div class="form-actions">
            <a href="{% url 'admin_panel:pattern_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-2"></i>å–æ¶ˆ
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save mr-2"></i>
                {% if pattern %}æ›´æ–°æ¨¡å¼{% else %}åˆ›å»ºæ¨¡å¼{% endif %}
            </button>
        </div>
    </form>
</div>

<!-- Quill.js JavaScript -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<!-- Lottie Player -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<script>
// å…¨å±€å˜é‡
let quill;
let uploadedLottieFiles = [];

// Lottieæ–‡ä»¶å¤„ç†ç±»
class LottieHandler {
    constructor() {
        this.uploadedFiles = new Map();
        this.initUploadArea();
    }
    
    initUploadArea() {
        const uploadArea = document.getElementById('lottie-upload-area');
        const fileInput = document.getElementById('lottie-file');
        
        if (!uploadArea || !fileInput) {
            console.error('æ‰¾ä¸åˆ°ä¸Šä¼ åŒºåŸŸå…ƒç´ ');
            return;
        }

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                try {
                    await this.processLottieFile(file);
                } catch (error) {
                    alert(`å¤„ç†æ–‡ä»¶ "${file.name}" æ—¶å‡ºé”™: ${error.message}`);
                }
            }
            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            e.target.value = '';
        });

        // æ‹–æ‹½ä¸Šä¼ å¤„ç†
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f0f8ff';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
        });

        uploadArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            
            const files = Array.from(e.dataTransfer.files);
            for (const file of files) {
                try {
                    await this.processLottieFile(file);
                } catch (error) {
                    alert(`å¤„ç†æ–‡ä»¶ "${file.name}" æ—¶å‡ºé”™: ${error.message}`);
                }
            }
        });
    }
    
    async processLottieFile(file) {
        try {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!this.isValidLottieFile(file)) {
                throw new Error('è¯·ä¸Šä¼ æœ‰æ•ˆçš„Lottieæ–‡ä»¶ï¼ˆ.jsonæˆ–.lottieæ ¼å¼ï¼‰');
            }

            // ç”Ÿæˆå”¯ä¸€ID
            const fileId = 'lottie_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // è¯»å–æ–‡ä»¶å†…å®¹
            const fileContent = await this.readFileAsText(file);
            let lottieData;

            try {
                lottieData = JSON.parse(fileContent);
            } catch (e) {
                throw new Error('Lottieæ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œæ— æ³•è§£æJSON');
            }

            // åˆ›å»ºæ•°æ®URL
            const dataUrl = `data:application/json;charset=utf-8,${encodeURIComponent(fileContent)}`;

            // å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
            const fileInfo = {
                id: fileId,
                name: file.name,
                size: file.size,
                data: lottieData,
                dataUrl: dataUrl,
                uploadTime: new Date()
            };

            this.uploadedFiles.set(fileId, fileInfo);

            // æ˜¾ç¤ºé¢„è§ˆ
            this.showPreview(fileInfo);

            return fileId;
        } catch (error) {
            console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
            throw error;
        }
    }
    
    isValidLottieFile(file) {
        // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
        const validExtensions = ['.json', '.lottie'];
        const fileName = file.name.toLowerCase();
        const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
        
        // æ£€æŸ¥MIMEç±»å‹
        const validMimeTypes = ['application/json', 'text/json', 'application/octet-stream'];
        const hasValidMimeType = validMimeTypes.includes(file.type) || file.type === '';
        
        return hasValidExtension && (hasValidMimeType || file.type === '');
    }
    
    isValidLottieData(data) {
        // æ£€æŸ¥åŸºæœ¬çš„Lottieæ•°æ®ç»“æ„
        return data && 
               typeof data === 'object' && 
               (data.v || data.version) && // ç‰ˆæœ¬ä¿¡æ¯
               (data.layers || data.assets) && // å›¾å±‚æˆ–èµ„æº
               (data.w || data.width) && // å®½åº¦
               (data.h || data.height); // é«˜åº¦
    }
    
    showPreview(fileInfo) {
        const previewsContainer = document.getElementById('lottie-previews');
        
        // åˆ›å»ºé¢„è§ˆå…ƒç´ 
        const preview = document.createElement('div');
        preview.className = 'lottie-preview';
        preview.innerHTML = `
            <lottie-player 
                src="${fileInfo.dataUrl}" 
                background="transparent" 
                speed="1" 
                loop 
                autoplay>
            </lottie-player>
            <div class="lottie-info">
                <strong>${fileInfo.name}</strong>
                <div>å¤§å°: ${(fileInfo.size / 1024).toFixed(1)} KB</div>
            </div>
            <div class="lottie-controls">
                <button type="button" class="lottie-btn primary" onclick="insertLottieToEditor('${fileInfo.id}')">
                    æ’å…¥åˆ°ç¼–è¾‘å™¨
                </button>
                <button type="button" class="lottie-btn danger" onclick="removeLottieFile('${fileInfo.id}')">
                    åˆ é™¤
                </button>
            </div>
        `;
        
        previewsContainer.appendChild(preview);
        
        // ç›‘å¬Lottie PlayeråŠ è½½äº‹ä»¶
        const lottiePlayer = preview.querySelector('lottie-player');
        lottiePlayer.addEventListener('ready', () => {
            console.log(`Lottieé¢„è§ˆåŠ è½½æˆåŠŸ: ${fileInfo.name}`);
        });
        
        lottiePlayer.addEventListener('error', (e) => {
            console.error(`Lottieé¢„è§ˆåŠ è½½å¤±è´¥: ${fileInfo.name}`, e);
            preview.innerHTML = `
                <div style="width: 200px; height: 150px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border: 1px solid #ddd; color: #666;">
                    é¢„è§ˆå¤±è´¥
                </div>
                <div class="lottie-controls">
                    <button type="button" class="lottie-btn primary" onclick="insertLottieToEditor('${fileInfo.id}')">
                        æ’å…¥åˆ°ç¼–è¾‘å™¨
                    </button>
                    <button type="button" class="lottie-btn danger" onclick="removeLottieFile('${fileInfo.id}')">
                        åˆ é™¤
                    </button>
                </div>
                <div class="lottie-info">
                    <div style="font-weight: bold; margin-bottom: 4px;">${fileInfo.name}</div>
                    <div>é¢„è§ˆåŠ è½½å¤±è´¥ï¼Œä½†ä»å¯æ’å…¥</div>
                </div>
            `;
        });
    }
    
    removeLottieFile(fileId) {
        if (this.uploadedFiles.has(fileId)) {
            this.uploadedFiles.delete(fileId);
            this.hidePreview();
            console.log('Lottieæ–‡ä»¶å·²åˆ é™¤:', fileId);
        }
    }
    
    getLottieFile(fileId) {
        return this.uploadedFiles.get(fileId);
    }

    async readFileAsText(file) {
        const reader = new FileReader();
        const result = await new Promise((resolve, reject) => {
            reader.onload = (e) => {
                resolve(e.target.result);
            };
            reader.onerror = (e) => {
                reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
            };
            reader.readAsText(file);
        });
        return result;
    }

    hidePreview() {
        const previews = document.querySelectorAll('.lottie-preview');
        previews.forEach(preview => {
            preview.remove();
        });
    }
}

// å…¨å±€å‡½æ•°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function insertLottieToEditor(fileId) {
    console.log('å°è¯•æ’å…¥Lottieæ–‡ä»¶:', fileId);
    
    const lottieFile = window.lottieHandler.getLottieFile(fileId);
    if (!lottieFile) {
        console.error('æ‰¾ä¸åˆ°Lottieæ–‡ä»¶:', fileId);
        alert('æ‰¾ä¸åˆ°Lottieæ–‡ä»¶ï¼Œè¯·é‡æ–°ä¸Šä¼ ');
        return;
    }
    
    if (!quill) {
        console.error('Quillç¼–è¾‘å™¨æœªåˆå§‹åŒ–');
        alert('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }

    // è®©ç¼–è¾‘å™¨è·å¾—ç„¦ç‚¹
    quill.focus();

    // è·å–å½“å‰å…‰æ ‡ä½ç½®
    let range = quill.getSelection();
    if (!range) {
        alert('è¯·å…ˆåœ¨ç¼–è¾‘å™¨ä¸­ç‚¹å‡»éœ€è¦æ’å…¥çš„ä½ç½®');
        return;
    }

    try {
        // åˆ›å»ºLottieæ•°æ®å¯¹è±¡
        const lottieData = {
            id: fileId,
            dataUrl: lottieFile.dataUrl,
            fileName: lottieFile.name,
            fileSize: formatFileSize(lottieFile.size)
        };

        console.log('æ’å…¥Lottieæ•°æ®:', lottieData);

        // æ’å…¥Lottieå…ƒç´ 
        quill.insertEmbed(range.index, 'lottie', lottieData);
        
        // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å…ƒç´ ä¹‹å
        quill.setSelection(range.index + 1);
        
        console.log('Lottieå…ƒç´ å·²æˆåŠŸæ’å…¥åˆ°ç¼–è¾‘å™¨');
        alert('LottieåŠ¨ç”»å·²æˆåŠŸæ’å…¥åˆ°ç¼–è¾‘å™¨ï¼');
        
        // éšè—é¢„è§ˆ
        window.lottieHandler.hidePreview();
        
    } catch (error) {
        console.error('æ’å…¥Lottieå…ƒç´ å¤±è´¥:', error);
        alert('æ’å…¥Lottieå…ƒç´ å¤±è´¥: ' + error.message);
    }
}

function removeLottieFile(fileId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªLottieæ–‡ä»¶å—ï¼Ÿ')) {
        window.lottieHandler.removeLottieFile(fileId);
    }
}

function toggleLottiePlay(button) {
    const lottieEmbed = button.closest('.lottie-embed');
    const lottiePlayer = lottieEmbed.querySelector('lottie-player');
    
    if (lottiePlayer) {
        if (lottiePlayer.currentState === 'playing') {
            lottiePlayer.pause();
            button.innerHTML = 'â–¶ï¸ æ’­æ”¾';
        } else {
            lottiePlayer.play();
            button.innerHTML = 'â¸ï¸ æš‚åœ';
        }
    }
}

function restartLottie(button) {
    const lottieEmbed = button.closest('.lottie-embed');
    const lottiePlayer = lottieEmbed.querySelector('lottie-player');
    
    if (lottiePlayer) {
        lottiePlayer.stop();
        lottiePlayer.play();
        
        // æ›´æ–°æ’­æ”¾æŒ‰é’®çŠ¶æ€
        const playButton = lottieEmbed.querySelector('button[onclick*="toggleLottiePlay"]');
        if (playButton) {
            playButton.innerHTML = 'â¸ï¸ æš‚åœ';
        }
    }
}

function deleteLottie(button) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªLottieåŠ¨ç”»å—ï¼Ÿ')) {
        const lottieEmbed = button.closest('.ql-lottie');
        if (lottieEmbed) {
            // è·å–Lottieå…ƒç´ åœ¨ç¼–è¾‘å™¨ä¸­çš„ä½ç½®
            const blot = Quill.find(lottieEmbed);
            if (blot) {
                const index = quill.getIndex(blot);
                quill.deleteText(index, 1);
                console.log('Lottieå…ƒç´ å·²ä»ç¼–è¾‘å™¨ä¸­åˆ é™¤');
            }
        }
    }
}

function downloadLottie(fileId) {
    const lottieFile = window.lottieHandler.getLottieFile(fileId);
    if (!lottieFile) {
        alert('æ‰¾ä¸åˆ°Lottieæ–‡ä»¶');
        return;
    }
    
    const link = document.createElement('a');
    link.href = lottieFile.dataUrl;
    link.download = lottieFile.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('Lottieæ–‡ä»¶å·²ä¸‹è½½:', lottieFile.name);
}

// è‡ªå®šä¹‰Lottie Blotç±»
class LottieBlot extends Quill.import('blots/block/embed') {
    static create(value) {
        let node = super.create();
        node.setAttribute('contenteditable', false);
        node.setAttribute('data-lottie-id', value.id);
        node.innerHTML = `
            <div class="lottie-embed" style="background: black; border-radius: 16px; padding: 20px; margin: 20px 0; position: relative; overflow: hidden;">
                <lottie-player 
                    src="${value.dataUrl}" 
                    background="transparent" 
                    speed="1" 
                    style="max-width: 100%;" 
                    loop 
                    autoplay>
                </lottie-player>
                <div class="lottie-info" style="margin-top: 20px; color: rgba(255, 255, 255, 0.8); font-size: 12px;">
                    <strong style="color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 12px;">${value.fileName}</strong>
                    <div style="color: rgba(255, 255, 255, 0.6);">æ–‡ä»¶å¤§å°: ${value.fileSize}</div>
                </div>
            </div>
        `;
        return node;
    }

    static value(node) {
        return {
            id: node.getAttribute('data-lottie-id'),
            dataUrl: node.querySelector('lottie-player').getAttribute('src'),
            fileName: node.querySelector('.lottie-info strong').textContent,
            fileSize: node.querySelector('.lottie-info div').textContent.replace('æ–‡ä»¶å¤§å°: ', '')
        };
    }

    // ä¿®å¤deleteAtæ–¹æ³•ï¼Œç¡®ä¿èƒ½æ­£ç¡®åˆ é™¤
    deleteAt(index, length) {
        // å¦‚æœåˆ é™¤æ•´ä¸ªblotï¼Œè°ƒç”¨çˆ¶ç±»æ–¹æ³•
        if (index === 0 && length >= this.length()) {
            super.deleteAt(index, length);
        }
        // å¦‚æœæ˜¯éƒ¨åˆ†åˆ é™¤ï¼Œä¸å…è®¸ï¼ˆembed blotåº”è¯¥æ•´ä½“åˆ é™¤ï¼‰
        // è¿™æ ·å¯ä»¥ç¡®ä¿å…¨é€‰åˆ é™¤æ—¶èƒ½æ­£ç¡®åˆ é™¤æ•´ä¸ªblot
    }
    
    // é‡å†™lengthæ–¹æ³•ç¡®ä¿è¿”å›æ­£ç¡®çš„é•¿åº¦
    length() {
        return 1;
    }
}

LottieBlot.blotName = 'lottie';
LottieBlot.tagName = 'div';
LottieBlot.className = 'ql-lottie';

// æ³¨å†Œè‡ªå®šä¹‰æ ¼å¼
Quill.register(LottieBlot);

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('åˆå§‹åŒ–Quillç¼–è¾‘å™¨å’ŒLottieå¤„ç†å™¨...');
    
    // åˆå§‹åŒ–Lottieå¤„ç†å™¨
    window.lottieHandler = new LottieHandler();
    
    // åˆå§‹åŒ–Quillç¼–è¾‘å™¨
    quill = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'code-block'],
                ['link', 'image'],
                ['clean']
            ]
        },
        formats: [
            'header', 'bold', 'italic', 'underline', 'strike',
            'color', 'background',
            'list', 'bullet', 'blockquote', 'code-block',
            'link', 'image', 'lottie'
        ]
    });
    
    // è®¾ç½®åˆå§‹å†…å®¹
    const initialContent = document.getElementById('content-input').value;
    if (initialContent) {
        quill.clipboard.dangerouslyPasteHTML(initialContent);
    }
    
    // ç›‘å¬å†…å®¹å˜åŒ–
    quill.on('text-change', function() {
        const content = quill.root.innerHTML;
        document.getElementById('content-input').value = content;
        console.log('å†…å®¹å·²æ›´æ–°');
    });
    
    // æ·»åŠ é”®ç›˜äº‹ä»¶å¤„ç†ï¼Œç¡®ä¿å…¨é€‰åˆ é™¤åŠŸèƒ½æ­£å¸¸
    quill.keyboard.addBinding({
        key: 'A',
        ctrlKey: true
    }, function(range, context) {
        quill.setSelection(0, quill.getLength());
        return false;
    });
    quill.keyboard.addBinding({
        key: 'A',
        metaKey: true
    }, function(range, context) {
        quill.setSelection(0, quill.getLength());
        return false;
    });
    quill.keyboard.addBinding({
        key: 'Backspace'
    }, function(range, context) {
        if (range && range.length > 0) {
            quill.deleteText(range.index, range.length);
            quill.setSelection(range.index);
            return false;
        }
        return true;
    });
    quill.keyboard.addBinding({
        key: 'Delete'
    }, function(range, context) {
        if (range && range.length > 0) {
            quill.deleteText(range.index, range.length);
            quill.setSelection(range.index);
            return false;
        }
        return true;
    });
    
    // è¡¨å•æäº¤å‰ç¡®ä¿å†…å®¹åŒæ­¥
    document.getElementById('pattern-form').addEventListener('submit', function(e) {
        const content = quill.root.innerHTML;
        document.getElementById('content-input').value = content;
        console.log('è¡¨å•æäº¤ï¼Œå†…å®¹å·²åŒæ­¥');
    });
    
    // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
    setupFileUpload();
    
    // æ·»åŠ æ¸…ç©ºç¼–è¾‘å™¨çš„è¾…åŠ©å‡½æ•°
    window.clearEditor = function() {
        if (quill) {
            quill.setContents([]);
            quill.history.clear();
            console.log('ç¼–è¾‘å™¨å·²æ¸…ç©º');
        }
    };
    
    console.log('Quillç¼–è¾‘å™¨å’ŒLottieå¤„ç†å™¨åˆå§‹åŒ–å®Œæˆ');
});

function setupFileUpload() {
    const uploadArea = document.getElementById('cover-upload-area');
    const fileInput = document.getElementById('cover_image');
    
    if (!uploadArea || !fileInput) return;
    
    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
    uploadArea.addEventListener('click', function(e) {
        if (e.target.tagName !== 'INPUT') {
            fileInput.click();
        }
    });
    
    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    function handleFileSelect(file) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadContent = uploadArea.querySelector('.upload-content');
                uploadContent.innerHTML = `
                    <div class="preview-container">
                        <img src="${e.target.result}" alt="é¢„è§ˆ" style="max-width: 200px; max-height: 150px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <p class="text-sm text-green-600 mt-2 font-medium">
                            <i class="fas fa-check-circle mr-1"></i>
                            å·²é€‰æ‹©: ${file.name}
                        </p>
                        <p class="text-xs text-gray-500">ç‚¹å‡»é‡æ–°é€‰æ‹©</p>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
        }
    }
}

// è¡¨å•éªŒè¯
document.getElementById('pattern-form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const category = document.getElementById('category').value;
    
    if (!title) {
        alert('è¯·è¾“å…¥æ¨¡å¼æ ‡é¢˜ï¼');
        e.preventDefault();
        return;
    }
    
    if (!description) {
        alert('è¯·è¾“å…¥æ¨¡å¼æè¿°ï¼');
        e.preventDefault();
        return;
    }
    
    if (!category) {
        alert('è¯·é€‰æ‹©æ‰€å±åˆ†ç±»ï¼');
        e.preventDefault();
        return;
    }
    
    console.log('è¡¨å•éªŒè¯é€šè¿‡ï¼Œæ­£åœ¨æäº¤...');
});
</script>
<!-- Lottieç¼–è¾‘å™¨ä¼˜åŒ– -->
<style>
.ql-editor .ql-lottie {
    display: inline-flex !important;
    align-items: center !important;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)) !important;
    border: 1px solid rgba(34, 197, 94, 0.3) !important;
    border-radius: 20px !important;
    padding: 4px 12px !important;
    margin: 0 4px !important;
    font-size: 12px !important;
    color: rgba(34, 197, 94, 0.9) !important;
    cursor: pointer !important;
    max-width: 200px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    font-weight: 500 !important;
    vertical-align: middle !important;
}
</style>
{% endblock %}  